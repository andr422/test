<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π ABA –ß–µ–∫-–ª–∏—Å—Ç</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 16px; max-width: 960px; margin: auto; background: #f8f9fa; }
    h2, h3 { text-align: center; }
    .controls { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    body.editing .btn-set button { pointer-events:none; opacity:0.5; }

    .protocol-container { background:#fff; border-radius:12px; padding:16px; margin-bottom:24px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .block { margin-bottom:16px; padding: 8px; border-radius: 8px; }
    .block.mastered { border: 2px solid green; background: #e6ffe6; }

    .goal-label { display:block; padding:8px; background:#e9ecef; border-radius:4px; margin-bottom:8px; }

    .btn-set { display:flex; justify-content:space-around; gap:12px; margin-bottom:8px; }
    .btn-set button { flex:1; padding:18px; font-size:26px; border:none; border-radius:12px; cursor:pointer; }
    .btn-success{ background:#d4edda; } .btn-prompt{ background:#fff3cd; } .btn-error{ background:#f8d7da; }
    .count { text-align:center; font-weight:bold; font-size:16px; margin-top:6px; }

    .percent { text-align:right; font-weight:bold; }
    .percent.mastered { color: green; font-weight: bold; }

    .prev-percent { font-size:12px; color:#555; margin-top:4px; }
    .prev-percent::before { content:'–ü—Ä–µ–¥. —Å–µ—Å—Å–∏–∏: '; font-weight:bold; }

    #clearBtn { padding:8px 16px; font-size:14px; border:none; border-radius:8px; background:#dc3545; color:#fff; cursor:pointer; transition:background 0.2s; }
    #clearBtn:hover { background:#c82333; }

    #goal-selector-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    #goal-selector-modal .modal-content { background:#fff; padding:20px; border-radius:8px; max-width:400px; max-height:80%; overflow:auto; }

    #undo-banner { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#e0e0e0; padding:8px 16px; border-radius:20px; font-size:14px; display:none; box-shadow:0 2px 6px rgba(0,0,0,0.1); cursor:pointer; }

    .history-table { width:100%; border-collapse:collapse; margin-bottom:16px; font-size:14px; }
    .history-table th, .history-table td { border:1px solid #ccc; padding:4px 6px; }
    .history-table th { background:#f0f0f0; }

    .nav-left-floating { position:fixed; bottom:20px; left:20px; }
    .nav-left-floating a { background:#007bff; color:white; padding:14px 18px; border-radius:30px; text-decoration:none; }

    /* Modal for prompt selection */
    #prompt-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    #prompt-modal .modal-content { background:#fff; padding:20px; border-radius:8px; max-width:320px; }
    #prompt-modal button { display:block; width:100%; margin:6px 0; padding:10px; font-size:16px; border:none; border-radius:6px; background:#f1f1f1; cursor:pointer; }
    #prompt-modal button:hover { background:#ddd; }
  </style>
</head>
<body>
  <h2>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π ABA –ß–µ–∫-–ª–∏—Å—Ç</h2>
  <div class="controls">
    <div>
      <label for="modeSlider">–†–µ–∂–∏–º:</label>
      <input id="modeSlider" type="range" min="0" max="1" value="1"/>
      <span id="modeText">–ó–∞–ø–∏—Å—å –æ—Ç–≤–µ—Ç–æ–≤</span>
    </div>
    <button id="clearBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
  </div>

  <div id="goal-selector-modal">
    <div class="modal-content">
      <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª–∏</h3>
      <div id="goal-options"></div>
      <button onclick="saveSelectedGoals()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button onclick="closeGoalSelector()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <div id="dailyContainer"></div>
  <div id="undo-banner">–û—Ç–º–µ–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ</div>
  <div id="historyContainer"><h2>–ò—Å—Ç–æ—Ä–∏—è —Å–µ—Å—Å–∏–π</h2></div>

  <div class="nav-left-floating">
    <a href="summary_fixed_igram.html">‚¨Ö –°–≤–æ–¥–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç</a>
  </div>

  <!-- Modal for selecting prompt type -->
  <div id="prompt-modal">
    <div class="modal-content">
      <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–¥—Å–∫–∞–∑–∫–∏</h3>
      <button onclick="selectPrompt('G')">–ñ–µ—Å—Ç–æ–≤–∞—è</button>
      <button onclick="selectPrompt('V')">–í–µ—Ä–±–∞–ª—å–Ω–∞—è</button>
      <button onclick="selectPrompt('E')">–≠—Ö–æ</button>
      <button onclick="selectPrompt('PF')">–ß–∞—Å—Ç–∏—á–Ω–∞—è —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è</button>
      <button onclick="selectPrompt('FF')">–ü–æ–ª–Ω–∞—è —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è</button>
      <button onclick="closePromptModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <script>
    const modeSlider       = document.getElementById('modeSlider');
    const modeText         = document.getElementById('modeText');
    const dailyContainer   = document.getElementById('dailyContainer');
    const historyContainer = document.getElementById('historyContainer');
    const undoBanner       = document.getElementById('undo-banner');

    let undoStack = [];

    // long-press helpers for ü§ù
    let longPressTimer = null;
    let suppressNextClick = false;
    let currentPromptTarget = null;

    // persist prompt details across reloads
    // —ç—Ç–æ –º–∞—Å—Å–∏–≤ –ø–æ –≤—Å–µ–º –±–ª–æ–∫–∞–º (–≤ –ø–æ—Ä—è–¥–∫–µ DOM): {G,V,E,PF,FF}
    function getSavedPromptDetails() {
      return JSON.parse(localStorage.getItem('aba_prompt_details') || '[]');
    }
    function setSavedPromptDetails(arr) {
      localStorage.setItem('aba_prompt_details', JSON.stringify(arr));
    }

    /* ================== MODE ================== */
    function toggleMode() {
      const edit = modeSlider.value === '0';
      document.body.classList.toggle('editing', edit);
      modeText.textContent = edit ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ' : '–ó–∞–ø–∏—Å—å –æ—Ç–≤–µ—Ç–æ–≤';
    }

    /* ================ STORAGE HELPERS ================= */
    function getProtocolsCount() {
      return Object.keys(localStorage)
        .map(k => (k.match(/^protocol(\d+)_title$/) || [])[1])
        .filter(Boolean).map(Number)
        .reduce((max, n) => Math.max(max, n), 0);
    }

    /* ============== GOAL SELECTOR MODAL ============== */
    function openGoalSelector(idx) {
      window.currentProtocol = idx;
      const opts = document.getElementById('goal-options');
      opts.innerHTML = '';
      const saved = JSON.parse(localStorage.getItem(`protocol${idx}_selectedGoals`) || '[]');
      for (let j = 1; j <= 10; j++) {
        const text = localStorage.getItem(`protocol${idx}_goal${j}`) || `–¶–µ–ª—å ${j}`;
        const cb = document.createElement('input');
        cb.type = 'checkbox'; cb.id = `g${j}`; cb.value = j;
        if (saved.includes(j)) cb.checked = true;
        cb.onchange = () => {
          if (opts.querySelectorAll('input:checked').length > 10) cb.checked = false;
        };
        const lb = document.createElement('label'); lb.htmlFor = cb.id; lb.textContent = text;
        const row = document.createElement('div'); row.append(cb, lb);
        opts.append(row);
      }
      document.getElementById('goal-selector-modal').style.display = 'flex';
    }
    function closeGoalSelector() {
      document.getElementById('goal-selector-modal').style.display = 'none';
    }

    function saveSelectedGoals() {
      const idx = window.currentProtocol;

      const oldNames = JSON.parse(localStorage.getItem(`protocol${idx}_goalNames`) || '[]');
      const newSel   = [...document.querySelectorAll('#goal-options input:checked')].map(cb => +cb.value);
      const newNames = newSel.map(j => localStorage.getItem(`protocol${idx}_goal${j}`) || '');

      localStorage.setItem(`protocol${idx}_selectedGoals`, JSON.stringify(newSel));
      localStorage.setItem(`protocol${idx}_goalNames`, JSON.stringify(newNames));

      // –ø–µ—Ä–µ–Ω–æ—Å –∏—Å—Ç–æ—Ä–∏–∏ —Ç–æ–ª—å–∫–æ –ø–æ —Å–æ–≤–ø–∞–¥–∞—é—â–∏–º –∏–º–µ–Ω–∞–º
      let history = JSON.parse(localStorage.getItem('aba_history') || '[]');
      history = history.map(sess => {
        const oldData = sess.data[idx - 1] || [];
        const newData = newNames.map(name => {
          const oldIndex = oldNames.indexOf(name);
          return oldIndex !== -1 ? oldData[oldIndex] : null;
        });
        sess.data[idx - 1] = newData;
        return sess;
      });
      localStorage.setItem('aba_history', JSON.stringify(history));

      // –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—É—â–∏—Ö —Å—á—ë—Ç—á–∏–∫–æ–≤ (–ø–æ 3 –Ω–∞ —Ü–µ–ª—å)
      const oldCounts = JSON.parse(localStorage.getItem('aba_counts') || '[]');
      const newCounts = [];
      newNames.forEach(name => {
        const oldIndex = oldNames.indexOf(name);
        if (oldIndex !== -1) {
          newCounts.push(oldCounts[oldIndex * 3] || '0',
                         oldCounts[oldIndex * 3 + 1] || '0',
                         oldCounts[oldIndex * 3 + 2] || '0');
        } else {
          newCounts.push('0','0','0');
        }
      });
      localStorage.setItem('aba_counts', JSON.stringify(newCounts));

      // –ø–µ—Ä–µ–Ω–æ—Å –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫: –Ω–∞ –∫–∞–∂–¥—É—é –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ü–µ–ª—å —Å–≤–æ–π –æ–±—ä–µ–∫—Ç {G,V,E,PF,FF}
      const oldPD = getSavedPromptDetails();
      const newPD = [];
      newNames.forEach(name => {
        const oldIndex = oldNames.indexOf(name);
        if (oldIndex !== -1 && oldPD[oldIndex]) {
          newPD.push(oldPD[oldIndex]);
        } else {
          newPD.push({G:0,V:0,E:0,PF:0,FF:0});
        }
      });
      setSavedPromptDetails(newPD);

      closeGoalSelector();
      renderDaily();
      loadProgress();
      renderHistory();
    }

    /* =============== MASTERY CHECK =============== */
    function checkMastery(goalHistory) {
      const last3 = goalHistory.slice(-3).filter(v => v != null);
      return last3.length === 3 && last3.every(v => v >= 80);
    }

    /* ================= RENDER DAILY ================= */
    function renderDaily() {
      const hist  = JSON.parse(localStorage.getItem('aba_history') || '[]');
      const last3 = hist.slice(-3);

      dailyContainer.innerHTML = '';
      const cnt = getProtocolsCount();

      for (let i = 1; i <= cnt; i++) {
        const wrapper = document.createElement('div');
        wrapper.className = 'protocol-container';
        wrapper.dataset.index = i;

        const title = localStorage.getItem(`protocol${i}_title`) || `–ü—Ä–æ—Ç–æ–∫–æ–ª ${i}`;
        const sel   = JSON.parse(localStorage.getItem(`protocol${i}_selectedGoals`) || '[]');
        const toShow = sel.length ? sel : [1,2,3];

        wrapper.innerHTML = `<h3>${title}</h3><button onclick="openGoalSelector(${i})">–í—ã–±—Ä–∞—Ç—å —Ü–µ–ª–∏</button>`;

        toShow.forEach((j, rowPos) => {
          const txt = localStorage.getItem(`protocol${i}_goal${j}`) || `–¶–µ–ª—å ${j}`;
          const prevArr = last3.map(sess => sess.data[i-1]?.[rowPos] ?? null);
          const prevPct = prevArr.map(v => v==null ? '‚Äî' : v + '%').join(' | ');
          const mastered = checkMastery(prevArr);

          const block = document.createElement('div');
          block.className = 'block' + (mastered ? ' mastered' : '');
          // –≤ data-index —Å–æ—Ö—Ä–∞–Ω–∏–º –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä –±–ª–æ–∫–∞ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å aba_prompt_details
          block.dataset.blockIndex = document.querySelectorAll('.block').length;

          block.innerHTML = `
            <div class="goal-label">${txt}</div>
            <div class="btn-set">
              <div><button class="btn-success" onclick="increment(this, '+')">‚úÖ</button><div class="count">0</div></div>
              <div><button class="btn-prompt" type="button">ü§ù</button><div class="count">0</div></div>
              <div><button class="btn-error"   onclick="increment(this, '-')">‚ûñ</button><div class="count">0</div></div>
            </div>
            <div class="percent">${mastered ? '–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ ‚úì' : '‚Äî'}</div>
            <div class="prev-percent">${prevPct}</div>
          `;
          wrapper.append(block);
        });

        dailyContainer.append(wrapper);
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º / –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø–æ–¥ —Ç–µ–∫—É—â–µ–µ —á–∏—Å–ª–æ –±–ª–æ–∫–æ–≤
      const blocks = Array.from(document.querySelectorAll('.block'));
      let pd = getSavedPromptDetails();
      if (pd.length !== blocks.length) {
        // —Ä–∞—Å—à–∏—Ä–∏–º/–æ–±—Ä–µ–∂–µ–º
        const fresh = [];
        for (let k = 0; k < blocks.length; k++) {
          fresh[k] = pd[k] || {G:0,V:0,E:0,PF:0,FF:0};
        }
        pd = fresh;
        setSavedPromptDetails(pd);
      }

      // –Ω–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ ü§ù –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
      wirePromptButtons();
    }

    /* ====== WIRE PROMPT (ü§ù) WITH LONG-PRESS ====== */
    function wirePromptButtons() {
      const modal = document.getElementById('prompt-modal');

      function startPress(btn) {
        suppressNextClick = false;
        longPressTimer = setTimeout(() => {
          suppressNextClick = true;
          currentPromptTarget = btn;
          modal.style.display = 'flex';
        }, 450);
      }
      function endPress() {
        if (longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      }

      document.querySelectorAll('.btn-prompt').forEach(btn => {
        // –º—ã—à—å
        btn.addEventListener('mousedown', () => startPress(btn));
        btn.addEventListener('mouseup', endPress);
        btn.addEventListener('mouseleave', endPress);

        // —Ç–∞—á
        btn.addEventListener('touchstart', (e) => { e.preventDefault(); startPress(btn); }, {passive:false});
        btn.addEventListener('touchend', endPress);
        btn.addEventListener('touchcancel', endPress);

        // –∫–æ—Ä–æ—Ç–∫–∏–π –∫–ª–∏–∫ = P
        btn.addEventListener('click', () => {
          if (suppressNextClick) { suppressNextClick = false; return; }
          increment(btn, 'P');
        });
      });
    }

    /* ================= RENDER HISTORY ================= */
    function renderHistory() {
      const hist = JSON.parse(localStorage.getItem('aba_history') || '[]');
      const cnt  = getProtocolsCount();
      historyContainer.innerHTML = '<h2>–ò—Å—Ç–æ—Ä–∏—è —Å–µ—Å—Å–∏–π</h2>';

      if (!hist.length) {
        historyContainer.innerHTML += '<p>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π.</p>';
        return;
      }

      for (let i = 1; i <= cnt; i++) {
        const title = localStorage.getItem(`protocol${i}_title`) || `–ü—Ä–æ—Ç–æ–∫–æ–ª ${i}`;
        const sel   = JSON.parse(localStorage.getItem(`protocol${i}_selectedGoals`) || '[]') || [1,2,3];

        const sec = document.createElement('div');
        sec.className = 'history-session';
        const hdr = document.createElement('h3'); hdr.textContent = title; sec.appendChild(hdr);

        const tbl = document.createElement('table'); tbl.className = 'history-table';
        const thead = tbl.createTHead(); const hr = thead.insertRow();
        const th0 = document.createElement('th'); th0.textContent = '–¶–µ–ª—å'; hr.appendChild(th0);

        hist.forEach(sess => {
          const th = document.createElement('th'); th.textContent = sess.date; hr.appendChild(th);
        });

        const tbody = tbl.createTBody();
        sel.forEach((gIdx, k) => {
          const tr = tbody.insertRow();
          const cell0 = tr.insertCell();
          cell0.textContent = localStorage.getItem(`protocol${i}_goal${gIdx}`) || `–¶–µ–ª—å ${gIdx}`;

          hist.forEach(sess => {
            const cell = tr.insertCell();
            const arr  = sess.data[i-1] || [];
            const v    = arr[k];
            let text = v == null ? '‚Äî' : v + '%';

            // –µ—Å–ª–∏ –µ—Å—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ –Ω–∞ —Ç—É —Å–µ—Å—Å–∏—é ‚Äî –¥–æ–±–∞–≤–∏–º –∫—Ä–∞—Ç–∫–æ
            const pdProt = (sess.promptDetails && sess.promptDetails[i-1]) || null;
            const pdStr  = pdProt ? pdProt[k] : null;
            if (pdStr && /\d/.test(pdStr)) {
              text += ' [' + pdStr + ']';
            }

            const mastered = checkMastery(arr);
            if (mastered && v != null) text += ' ‚úì';
            cell.textContent = text;
          });
        });

        sec.appendChild(tbl);
        historyContainer.appendChild(sec);
      }
    }

    /* ================== COUNTERS ================== */
    function increment(btn, type) {
      // type: '+', 'P', '-'
      const cntEl = btn.nextElementSibling;
      cntEl.textContent = (+cntEl.textContent || 0) + 1;

      // –µ—Å–ª–∏ —ç—Ç–æ –ø–æ–¥—Å–∫–∞–∑–∫–∞ ‚Äî —É–≤–µ–ª–∏—á–∏–º –¥–µ—Ç–∞–ª—å–Ω—ã–π —Å—á—ë—Ç—á–∏–∫ ¬´P (generic)¬ª –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø, –µ—Å–ª–∏ –æ–Ω –ø—Ä–∏—à—ë–ª –∏–∑ selectPrompt()
      if (type === 'P' && btn.classList.contains('btn-prompt')) {
        const block = btn.closest('.block');
        const blockIndex = Array.from(document.querySelectorAll('.block')).indexOf(block);
        const pd = getSavedPromptDetails();
        pd[blockIndex] = pd[blockIndex] || {G:0,V:0,E:0,PF:0,FF:0};
        // generic P —É–∂–µ —É—á–ª–∏ –≤ —Å—á—ë—Ç—á–∏–∫–µ; –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ selectPrompt()
        setSavedPromptDetails(pd);
      }

      updatePercentages();
      saveProgress();
      undoStack.push(btn);
      showUndo();
    }

    function updatePercentages() {
      document.querySelectorAll('.block').forEach(block => {
        const counts = [...block.querySelectorAll('.count')].map(d => +d.textContent || 0);
        const total  = counts.reduce((s, v) => s + v, 0);
        const el     = block.querySelector('.percent');
        if (total === 0) {
          el.textContent = '‚Äî';
          el.className = 'percent';
        } else {
          const ok = counts[0];
          const pct = Math.round(ok / total * 100);
          el.textContent = pct + '%';
          el.className = 'percent ' + (pct >= 80 ? 'green' : pct >= 50 ? 'orange' : 'red');
        }
      });
    }

    function saveProgress() {
      const arr = [...document.querySelectorAll('.count')].map(d => d.textContent);
      localStorage.setItem('aba_counts', JSON.stringify(arr));
    }

    function loadProgress() {
      const arr = JSON.parse(localStorage.getItem('aba_counts') || '[]');
      document.querySelectorAll('.count').forEach((d, i) => {
        if (arr[i] != null) d.textContent = arr[i];
      });
      updatePercentages();
    }

    /* ================= UNDO ================= */
    function showUndo() {
      undoBanner.style.display = 'block';
      clearTimeout(window.undoTimeout);
      window.undoTimeout = setTimeout(() => {
        if (!undoStack.length) undoBanner.style.display = 'none';
      }, 5000);
    }

    undoBanner.onclick = () => {
      if (undoStack.length) {
        const btn = undoStack.pop();
        const cnt = btn.nextElementSibling;
        cnt.textContent = Math.max(+cnt.textContent - 1, 0);

        // –µ—Å–ª–∏ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É ‚Äî –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ —É–º–µ–Ω—å—à–∏—Ç—Å—è (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏)
        updatePercentages();
        saveProgress();
      }
      if (!undoStack.length) undoBanner.style.display = 'none';
    };

    /* ================== SEND SESSION ================== */
    function compactPrompt(pdObj) {
      // –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º {G:2,V:1,E:0,PF:1,FF:0} -> "G2 V1 E0 PF1 FF0" (—Ç–æ–ª—å–∫–æ >0 –ø–æ–∫–∞–∑—ã–≤–∞–µ–º)
      const parts = [];
      if (!pdObj) return '';
      for (const key of ['G','V','E','PF','FF']) {
        const n = pdObj[key] || 0;
        if (n > 0) parts.push(key + n);
      }
      return parts.join(' ');
    }

    function clearData() {
      const date  = new Date().toLocaleDateString('ru-RU');
      const child = localStorage.getItem('child_name') || '';
      const session = { date, data: [], promptDetails: [] };

      const allBlocks = Array.from(document.querySelectorAll('.block'));
      const pdAll = getSavedPromptDetails();

      document.querySelectorAll('.protocol-container').forEach((pc, protIdx) => {
        const protocol = pc.querySelector('h3').textContent;
        const goalsHistory = [];
        const goalsServer  = [];
        const pdForProtocol = [];

        const blocks = Array.from(pc.querySelectorAll('.block'));
        blocks.forEach(block => {
          const name   = block.querySelector('.goal-label').textContent.trim();
          const counts = [...block.querySelectorAll('.count')].map(d => +d.textContent || 0);
          const total  = counts.reduce((s,v) => s + v, 0);
          const pct    = total ? Math.round(counts[0] / total * 100) : null;

          // —Å–æ–±—Ä–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É –∏–Ω–¥–µ–∫—Å—É –±–ª–æ–∫–∞
          const blockIndex = allBlocks.indexOf(block);
          const pdObj = pdAll[blockIndex] || {G:0,V:0,E:0,PF:0,FF:0};
          const pdStr = compactPrompt(pdObj);

          goalsHistory.push(pct);
          pdForProtocol.push(pdStr || '');

          // responses: –∫–∞–∫ –ø—Ä–µ–∂–¥–µ (+ P -), –∞ –¥–µ—Ç–∞–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–º –ø–æ–ª–µ–º
          const responses = [];
          for (let i = 0; i < counts[0]; i++) responses.push('+');
          for (let i = 0; i < counts[1]; i++) responses.push('P');
          for (let i = 0; i < counts[2]; i++) responses.push('-');

          goalsServer.push({
            name,
            responses: responses.join(' '),
            percent: pct != null ? pct + '%' : '',
            promptDetails: pdStr           // <--- –ù–û–í–û–ï –ü–û–õ–ï
          });
        });

        session.data.push(goalsHistory);
        session.promptDetails.push(pdForProtocol);

        // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É
        sendSessionResults({ protocol, date, child, goals: goalsServer });
      });

      // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –≤—Å—é —Å–µ—Å—Å–∏—é (—Å –¥–µ—Ç–∞–ª—è–º–∏ –ø–æ–¥—Å–∫–∞–∑–æ–∫)
      const hist = JSON.parse(localStorage.getItem('aba_history') || '[]');
      hist.push(session);
      if (hist.length > 10) hist.shift();
      localStorage.setItem('aba_history', JSON.stringify(hist));

      // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫–∏ –∏ –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
      document.querySelectorAll('.count').forEach(e => e.textContent = '0');
      setSavedPromptDetails(Array.from(document.querySelectorAll('.block')).map(() => ({G:0,V:0,E:0,PF:0,FF:0})));

      updatePercentages();
      saveProgress();
      renderHistory();
    }

    function sendSessionResults(sessionData) {
      // –ó–∞–º–µ–Ω–∏—Ç–µ URL –Ω–∞ —Å–≤–æ–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–π
      fetch('https://script.google.com/macros/s/AKfycbzR_QSNC8yEo6lJM2sTnDIlUU1QXOhcRcTYyCVW8M9NROjbZEMFYiUgoiU97nnL1-vY_g/exec', {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(sessionData)
      }).catch(console.error);
    }

    /* ============ PROMPT MODAL ============ */
    function closePromptModal() {
      document.getElementById('prompt-modal').style.display = 'none';
    }
    function selectPrompt(code) {
      // code: 'G' | 'V' | 'E' | 'PF' | 'FF'
      document.getElementById('prompt-modal').style.display = 'none';
      if (currentPromptTarget) {
        // 1) –æ–±—â–∏–π –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç ¬´P¬ª
        increment(currentPromptTarget, 'P');
        // 2) –¥–µ—Ç–∞–ª—å–Ω–∞—è –ø–æ–º–µ—Ç–∫–∞
        const block = currentPromptTarget.closest('.block');
        const blockIndex = Array.from(document.querySelectorAll('.block')).indexOf(block);
        const pd = getSavedPromptDetails();
        pd[blockIndex] = pd[blockIndex] || {G:0,V:0,E:0,PF:0,FF:0};
        pd[blockIndex][code] = (pd[blockIndex][code] || 0) + 1;
        setSavedPromptDetails(pd);
        currentPromptTarget = null;
      }
    }

    /* =============== INIT =============== */
    document.addEventListener('DOMContentLoaded', () => {
      modeSlider.oninput = toggleMode;
      document.getElementById('clearBtn').onclick = clearData;
      renderDaily();
      loadProgress();
      renderHistory();
      toggleMode();
    });
  </script>
</body>
</html>
